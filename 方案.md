# FCK工具混合模式校验文件实现方案

## 概述

本方案旨在为FCK工具的hash和check子命令添加混合模式支持，解决校验文件在不同环境间分发和使用的问题。

## 1. 需求分析

### 1.1 当前问题
- 校验文件使用绝对路径，无法在不同环境间移植
- 分发到其他电脑后路径不匹配导致校验失败
- 缺乏灵活的基准目录指定机制

### 1.2 目标
- 支持便携式校验文件生成（相对路径模式）
- 保持向后兼容性（本地绝对路径模式）
- 提供灵活的校验基准目录指定
- 简化用户操作，默认智能处理

## 2. 技术方案

### 2.1 文件头格式设计

#### 2.1.1 新文件头格式
```
# 本地模式（绝对路径）
#md5#2024-01-01 12:00:00#LOCAL#/original/base/path

# 便携模式（相对路径，默认模式）
#md5#2024-01-01 12:00:00#PORTABLE

# 兼容旧格式（无模式标识，默认为便携模式）
#md5#2024-01-01 12:00:00
```

#### 2.1.2 文件头解析规则
- 第一个`#`后为哈希算法类型
- 第二个`#`后为时间戳
- 第三个`#`后为模式标识（PORTABLE/LOCAL）
- 第四个`#`后为基准路径（仅LOCAL模式）
- **无第三个`#`时视为旧格式，默认为便携模式（PORTABLE）**

### 2.2 Hash子命令增强

#### 2.2.1 新增命令行标志
```go
// 在 commands/hash/flags.go 中添加
hashCmdLocal    = hashCmd.Bool("local", "L", false, "生成本地模式校验文件，记录绝对路径和基准目录")
hashCmdBasePath = hashCmd.String("base-path", "B", "", "指定基准路径（默认为当前工作目录）")
```

#### 2.2.2 使用示例
```bash
# 生成便携式校验文件（默认行为）
fck hash -w ./src

# 生成本地模式校验文件
fck hash --local -w ./src

# 指定基准路径的本地模式校验文件
fck hash --local --base-path /project/root -w ./src
```

#### 2.2.3 实现逻辑
1. **默认行为**：生成便携模式校验文件（PORTABLE），使用相对路径
2. **本地模式**：使用 `--local` 标志时，记录绝对路径和基准目录
3. **路径处理**：
   - 便携模式：将所有文件路径转换为相对于基准路径的相对路径
   - 本地模式：记录绝对路径，并在文件头中保存基准目录

### 2.3 Check子命令增强

#### 2.3.1 新增命令行标志
```go
// 在 commands/check/flags.go 中添加
checkCmdFile    = checkCmd.String("file", "f", "", "指定校验文件路径（默认为checksum.hash）")
checkCmdBaseDir = checkCmd.String("base-dir", "b", "", "手动指定校验基准目录（覆盖自动检测）")
```

#### 2.3.2 使用示例
```bash
# 使用默认校验文件，自动检测基准目录
fck check

# 指定校验文件，自动检测基准目录
fck check --file /path/to/custom.hash

# 手动指定基准目录（覆盖自动检测）
fck check --base-dir /opt/myapp

# 组合使用
fck check --file custom.hash --base-dir /project/root
```

#### 2.3.3 实现逻辑

##### 文件头解析增强
```go
// 扩展 parseHeader 函数
type HeaderInfo struct {
    HashType   string
    Timestamp  string
    Mode       string // PORTABLE, LOCAL, 或空（兼容旧格式）
    BasePath   string // LOCAL模式的基准路径
}

func (p *hashFileParser) parseHeaderEnhanced(scanner *bufio.Scanner) (*HeaderInfo, error) {
    // 解析新格式文件头
    // 支持向后兼容
}
```

##### 智能路径解析
```go
func (p *hashFileParser) resolveFilePath(filePath string, headerInfo *HeaderInfo, userBaseDir string) (string, error) {
    // 1. 绝对路径直接使用
    if filepath.IsAbs(filePath) {
        return filePath, nil
    }
    
    // 2. 用户手动指定基准目录优先
    if userBaseDir != "" {
        return filepath.Join(userBaseDir, filePath), nil
    }
    
    // 3. 根据文件头模式自动处理
    switch headerInfo.Mode {
    case "LOCAL":
        // LOCAL模式：使用文件头中的基准路径
        if headerInfo.BasePath != "" {
            return filepath.Join(headerInfo.BasePath, filePath), nil
        }
        // 如果没有基准路径，降级为便携模式处理
        fallthrough
    case "PORTABLE", "": // 便携模式或旧格式（默认便携模式）
        // 直接使用当前目录作为基准目录
        return filepath.Join(".", filePath), nil
    default:
        return "", fmt.Errorf("未知的校验文件模式: %s", headerInfo.Mode)
    }
}
```

## 3. 实现细节

### 3.1 代码结构调整

#### 3.1.1 新增类型定义
```go
// 在 commands/internal/types/types.go 中添加
const (
    // 校验文件模式
    ChecksumModePortable = "PORTABLE"
    ChecksumModeLocal    = "LOCAL"
)

// 文件头信息结构
type ChecksumHeader struct {
    HashType  string
    Timestamp string
    Mode      string
    BasePath  string
}
```

#### 3.1.2 Hash子命令修改点

**文件：commands/hash/hashtasks.go**
- 修改 `writeFileHeader` 函数，支持新的文件头格式
- 添加路径转换逻辑（绝对路径转相对路径）

**文件：commands/hash/cmd_hash.go**
- 添加模式检测和路径处理逻辑
- 集成新的命令行标志

#### 3.1.3 Check子命令修改点

**文件：commands/check/parser.go**
- 扩展 `parseHeader` 函数支持新格式
- 增强 `parseContent` 函数的路径解析能力
- 添加智能路径解析函数

**文件：commands/check/cmd_check.go**
- 修改校验文件路径获取逻辑
- 集成新的命令行标志

### 3.2 向后兼容性

#### 3.2.1 旧格式支持
- 检测文件头格式，无模式标识时默认为便携模式（PORTABLE）
- 旧格式文件按相对路径处理，提升兼容性

#### 3.2.2 渐进式升级
- 新功能通过命令行标志启用
- 默认行为改为便携模式，提升跨环境兼容性
- 提供迁移指导文档

### 3.3 错误处理和用户体验

#### 3.3.1 友好的错误信息
```go
// 路径不存在时的建议
if os.IsNotExist(err) {
    return fmt.Errorf("文件不存在: %s\n建议：\n1. 检查当前目录是否正确\n2. 使用 --base-dir 手动指定基准目录", resolvedPath)
}
```

#### 3.3.2 简化的路径处理逻辑
- **默认行为**：便携模式文件直接使用当前目录作为基准
- **LOCAL模式**：使用文件头中记录的基准路径
- **用户覆盖**：--base-dir 参数可以覆盖任何自动检测的结果

## 4. 测试方案

### 4.1 单元测试
- 文件头解析测试（新格式、旧格式、异常格式）
- 路径解析测试（各种路径组合）
- 模式转换测试（PORTABLE/LOCAL模式）

### 4.2 集成测试
- 端到端校验流程测试
- 跨平台兼容性测试
- 向后兼容性测试

### 4.3 场景测试
- 软件包分发场景
- 备份验证场景
- 跨平台迁移场景

## 5. 实施计划

### 5.1 第一阶段：基础功能
1. 扩展文件头格式支持
2. 实现hash子命令的默认便携模式
3. 基本的check子命令增强

### 5.2 第二阶段：完善功能
1. 本地模式支持
2. 智能路径解析优化
3. 用户体验改进

### 5.3 第三阶段：完善和优化
1. 全面测试和bug修复
2. 性能优化
3. 文档完善

## 6. 使用场景示例

### 6.1 软件包分发
```bash
# 开发环境（默认便携模式）
cd /project/myapp
fck hash -w .

# 用户环境
cd /opt/myapp
fck check  # 自动使用当前目录作为基准
```

### 6.2 备份验证
```bash
# 原始位置（默认便携模式）
cd /home/user/documents
fck hash -w .

# 备份位置
cd /backup/user-documents
fck check  # 自动使用当前目录作为基准
```

### 6.3 跨平台分发
```bash
# Windows开发环境（默认便携模式）
cd C:\project\src
fck hash -w .

# Linux部署环境
cd /opt/project/src
fck check  # 自动使用当前目录作为基准
```

### 6.4 本地绝对路径模式（特殊需求）
```bash
# 需要记录绝对路径时
cd /project/myapp
fck hash --local -w .

# 校验时会使用文件头中的绝对路径
fck check
```

## 7. 注意事项

### 7.1 路径分隔符处理
- 校验文件中统一使用正斜杠（/）作为路径分隔符
- 运行时根据操作系统自动转换

### 7.2 相对路径限制
- 便携模式下不支持超出基准目录的相对路径（../）
- 提供明确的错误提示和建议

### 7.3 性能考虑
- 大量文件时的路径转换性能优化
- 并发安全的路径处理

## 8. 总结

本方案通过简化的混合模式设计，默认采用便携模式提升跨环境兼容性，同时保留本地模式满足特殊需求。主要特点：

1. **默认便携**：无模式标识的文件默认按便携模式处理，提升兼容性
2. **自动检测**：check命令默认使用当前目录作为基准，无需额外配置
3. **简单易用**：减少命令行参数，降低使用复杂度
4. **向后兼容**：完全兼容现有校验文件格式
5. **灵活覆盖**：支持手动指定基准目录满足特殊需求

这种设计既解决了跨环境分发问题，又保持了简洁的用户体验。